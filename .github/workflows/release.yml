# HarborAIå‘å¸ƒæµæ°´çº¿
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'é¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  pull-requests: read
  actions: read

env:
  PYTHON_VERSION: '3.10'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç‰ˆæœ¬éªŒè¯
  validate-version:
    name: ç‰ˆæœ¬éªŒè¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: éªŒè¯ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            if [[ $VERSION =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (æ”¯æŒ PEP 440 æ ‡å‡†)
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "æ”¯æŒçš„æ ¼å¼: v1.0.0, v1.0.0-alpha, v1.0.0-beta.1, v1.0.0-rc.1"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $VERSION (é¢„å‘å¸ƒ: $IS_PRERELEASE)"

  # å®Œæ•´æµ‹è¯•å¥—ä»¶
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: validate-version
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: harborai_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          black --check .
          isort --check-only .
          flake8 harborai/ tests/
          mypy harborai/
          
      - name: å®‰å…¨æ£€æŸ¥
        run: |
          bandit -r harborai/
          safety check
          
      - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/harborai_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          python -m pytest \
            -v --tb=short \
            --cov=harborai \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=junit-${{ matrix.python-version }}.xml \
            --html=test-report-${{ matrix.python-version }}.html \
            --self-contained-html \
            -m "not slow"
            
      - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          coverage = float(tree.getroot().attrib['line-rate']) * 100
          print(f'ä»£ç è¦†ç›–ç‡: {coverage:.2f}%')
          if coverage < 80:
              print('âŒ ä»£ç è¦†ç›–ç‡ä½äº80%ï¼Œå‘å¸ƒå¤±è´¥')
              exit(1)
          print('âœ… ä»£ç è¦†ç›–ç‡æ£€æŸ¥é€šè¿‡')
          "
          
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports-${{ matrix.python-version }}
          path: |
            junit-*.xml
            test-report-*.html
            htmlcov/

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -m pytest tests/performance/ \
            -v --tb=short \
            -m "benchmark" \
            --benchmark-json=benchmark-results.json
            
      - name: éªŒè¯åŸºå‡†æµ‹è¯•ç»“æœ
        run: |
          if [ -f "benchmark-results.json" ]; then
            echo "âœ… åŸºå‡†æµ‹è¯•ç»“æœæ–‡ä»¶å·²ç”Ÿæˆ"
            echo "ğŸ“Š åŸºå‡†æµ‹è¯•ç»Ÿè®¡:"
            python -c "
          import json
          try:
              with open('benchmark-results.json', 'r') as f:
                  data = json.load(f)
              print(f'  æµ‹è¯•æ•°é‡: {len(data.get(\"benchmarks\", []))}')
              print(f'  æœºå™¨ä¿¡æ¯: {data.get(\"machine_info\", {}).get(\"machine\", \"æœªçŸ¥\")}')
              print(f'  Pythonç‰ˆæœ¬: {data.get(\"machine_info\", {}).get(\"python_version\", \"æœªçŸ¥\")}')
              print('âœ… åŸºå‡†æµ‹è¯•æ•°æ®éªŒè¯é€šè¿‡')
          except Exception as e:
              print(f'âŒ åŸºå‡†æµ‹è¯•æ•°æ®éªŒè¯å¤±è´¥: {e}')
              exit(1)
            "
          else
            echo "âŒ åŸºå‡†æµ‹è¯•ç»“æœæ–‡ä»¶æœªæ‰¾åˆ°"
            exit 1
          fi
            
      - name: æ›´æ–°æ€§èƒ½åŸºçº¿
        run: |
          mkdir -p tests/data/performance_baselines/
          cp benchmark-results.json tests/data/performance_baselines/baseline_${{ needs.validate-version.outputs.version }}.json
          
      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-benchmark
          path: |
            benchmark-results.json
            tests/data/performance_baselines/baseline_${{ needs.validate-version.outputs.version }}.json

  # æ„å»ºåˆ†å‘åŒ…
  build-package:
    name: æ„å»ºåˆ†å‘åŒ…
    runs-on: ubuntu-latest
    needs: [validate-version, full-test-suite]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…æ„å»ºå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          
      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          VERSION_NUM=${VERSION#v}
          echo "æ­£åœ¨æ›´æ–°ç‰ˆæœ¬å·åˆ°: $VERSION_NUM"
          
          # ä½¿ç”¨ Python è„šæœ¬æ›´æ–°ç‰ˆæœ¬å·ï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
          python -c "
          import re
          import sys
          
          version_num = '$VERSION_NUM'
          print(f'ç›®æ ‡ç‰ˆæœ¬å·: {version_num}')
          
          # æ›´æ–° pyproject.toml
          try:
              with open('pyproject.toml', 'r', encoding='utf-8') as f:
                  content = f.read()
              content = re.sub(r'version = \"[^\"]*\"', f'version = \"{version_num}\"', content)
              with open('pyproject.toml', 'w', encoding='utf-8') as f:
                  f.write(content)
              print(f'âœ… pyproject.toml ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: {version_num}')
          except Exception as e:
              print(f'âŒ æ›´æ–° pyproject.toml å¤±è´¥: {e}')
              sys.exit(1)
          
          # æ›´æ–° harborai/__init__.py
          try:
              with open('harborai/__init__.py', 'r', encoding='utf-8') as f:
                  content = f.read()
              content = re.sub(r'__version__ = \"[^\"]*\"', f'__version__ = \"{version_num}\"', content)
              with open('harborai/__init__.py', 'w', encoding='utf-8') as f:
                  f.write(content)
              print(f'âœ… harborai/__init__.py ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: {version_num}')
          except Exception as e:
              print(f'âŒ æ›´æ–° harborai/__init__.py å¤±è´¥: {e}')
              sys.exit(1)
          "
          
      - name: æ„å»ºåˆ†å‘åŒ…
        run: |
          python -m build
          
      - name: éªŒè¯åˆ†å‘åŒ…
        run: |
          python -m twine check dist/*
          
      - name: ä¸Šä¼ åˆ†å‘åŒ…
        uses: actions/upload-artifact@v3
        with:
          name: python-package
          path: dist/

  # æ„å»ºDockeré•œåƒ
  build-docker:
    name: æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [validate-version, full-test-suite]
    permissions:
      contents: read
      packages: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            
      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ç”Ÿæˆå‘å¸ƒè¯´æ˜
  generate-changelog:
    name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
    runs-on: ubuntu-latest
    needs: validate-version
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [[ -z "$PREV_TAG" ]]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          CHANGELOG="## ğŸš€ HarborAI $VERSION\n\n"
          CHANGELOG+="### ğŸ“‹ å˜æ›´å†…å®¹\n\n"
          CHANGELOG+="$COMMITS\n\n"
          CHANGELOG+="### ğŸ§ª æµ‹è¯•è¦†ç›–\n\n"
          CHANGELOG+="- âœ… å•å…ƒæµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… åŠŸèƒ½æµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… é›†æˆæµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… æ€§èƒ½æµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… å®‰å…¨æµ‹è¯•: é€šè¿‡\n\n"
          CHANGELOG+="### ğŸ“¦ å®‰è£…æ–¹å¼\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="pip install harborai==${VERSION#v}\n"
          CHANGELOG+="\`\`\`\n\n"
          CHANGELOG+="### ğŸ³ Dockeré•œåƒ\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION\n"
          CHANGELOG+="\`\`\`\n"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # åˆ›å»ºGitHub Release
  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, full-test-suite, performance-benchmark, build-package, build-docker, generate-changelog]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: python-package
          path: dist/
          
      - name: ä¸‹è½½æ€§èƒ½åŸºå‡†
        uses: actions/download-artifact@v3
        with:
          name: performance-benchmark
          path: performance/
          
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-version.outputs.version }}
          name: HarborAI ${{ needs.validate-version.outputs.version }}
          body: ${{ needs.generate-changelog.outputs.changelog }}
          prerelease: ${{ needs.validate-version.outputs.is_prerelease }}
          files: |
            dist/*
            performance/benchmark-results.json
            performance/baseline_${{ needs.validate-version.outputs.version }}.json
          token: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ°PyPI
  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    environment:
      name: pypi
      url: https://pypi.org/p/harborai
    permissions:
      id-token: write
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: python-package
          path: dist/
          
      - name: å‘å¸ƒåˆ°PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # ä½¿ç”¨ Trusted Publishingï¼Œä¸éœ€è¦ repository-url

  # å‘å¸ƒåˆ°TestPyPIï¼ˆé¢„å‘å¸ƒç‰ˆæœ¬ï¼‰
  publish-test-pypi:
    name: å‘å¸ƒåˆ°TestPyPI
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'true'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/harborai
    permissions:
      id-token: write
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: python-package
          path: dist/
          
      - name: å‘å¸ƒåˆ°TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  # éƒ¨ç½²æ–‡æ¡£
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…æ–‡æ¡£ä¾èµ–
        run: |
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
          
      - name: æ„å»ºæ–‡æ¡£
        run: |
          mkdocs build
          
      - name: éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # å‘å¸ƒé€šçŸ¥
  notify-release:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate-version, create-release, publish-pypi, deploy-docs]
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: å‘é€å‘å¸ƒé€šçŸ¥
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate-version.outputs.is_prerelease }}"
          
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "ğŸ‰ HarborAI $VERSION é¢„å‘å¸ƒç‰ˆæœ¬å·²å‘å¸ƒï¼"
            echo "ğŸ“¦ TestPyPI: https://test.pypi.org/project/harborai/"
          else
            echo "ğŸš€ HarborAI $VERSION æ­£å¼ç‰ˆæœ¬å·²å‘å¸ƒï¼"
            echo "ğŸ“¦ PyPI: https://pypi.org/project/harborai/"
            echo "ğŸ“š æ–‡æ¡£: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi
          
          echo "ğŸ³ Docker: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
          echo "ğŸ“‹ å‘å¸ƒè¯´æ˜: https://github.com/${{ github.repository }}/releases/tag/$VERSION"