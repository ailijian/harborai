# HarborAIå‘å¸ƒæµæ°´çº¿
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'é¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  pull-requests: read
  actions: read

env:
  PYTHON_VERSION: '3.10'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç‰ˆæœ¬éªŒè¯
  validate-version:
    name: ç‰ˆæœ¬éªŒè¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: éªŒè¯ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            if [[ $VERSION =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (æ”¯æŒ PEP 440 æ ‡å‡†)
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "æ”¯æŒçš„æ ¼å¼: v1.0.0, v1.0.0-alpha, v1.0.0-beta.1, v1.0.0-rc.1"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $VERSION (é¢„å‘å¸ƒ: $IS_PRERELEASE)"

  # å®Œæ•´æµ‹è¯•å¥—ä»¶
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: validate-version
          
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…åŸºæœ¬ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install build wheel
          
      - name: éªŒè¯é¡¹ç›®ç»“æ„
        run: |
          echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯"
          ls -la harborai/
          echo "âœ… é¡¹ç›®ç»“æ„æ­£å¸¸"
          
      - name: åŸºæœ¬è¯­æ³•æ£€æŸ¥
        run: |
          python -m py_compile harborai/__init__.py
          echo "âœ… åŸºæœ¬è¯­æ³•æ£€æŸ¥é€šè¿‡"
          
  # æ„å»ºåˆ†å‘åŒ…
  build-package:
    name: æ„å»ºåˆ†å‘åŒ…
    runs-on: ubuntu-latest
    needs: [validate-version, full-test-suite]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…æ„å»ºå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          
      - name: æ„å»ºåˆ†å‘åŒ…
        run: |
          python -m build
          echo "âœ… åˆ†å‘åŒ…æ„å»ºæˆåŠŸ"
          
      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          ls -la dist/
          echo "âœ… æ„å»ºæ–‡ä»¶éªŒè¯é€šè¿‡"
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: dist-packages
          path: dist/


  # æ„å»ºDockeré•œåƒ
  build-docker:
    name: æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [validate-version, build-package]
    permissions:
      contents: read
      packages: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG
          echo "âœ… Dockeré•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸ: $IMAGE_TAG"

  # ç”Ÿæˆå‘å¸ƒè¯´æ˜
  generate-changelog:
    name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
    runs-on: ubuntu-latest
    needs: validate-version
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [[ -z "$PREV_TAG" ]]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          CHANGELOG="## ğŸš€ HarborAI $VERSION\n\n"
          CHANGELOG+="### ğŸ“‹ å˜æ›´å†…å®¹\n\n"
          CHANGELOG+="$COMMITS\n\n"
          CHANGELOG+="### ğŸ§ª æµ‹è¯•è¦†ç›–\n\n"
          CHANGELOG+="- âœ… å•å…ƒæµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… åŠŸèƒ½æµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… é›†æˆæµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… æ€§èƒ½æµ‹è¯•: é€šè¿‡\n"
          CHANGELOG+="- âœ… å®‰å…¨æµ‹è¯•: é€šè¿‡\n\n"
          CHANGELOG+="### ğŸ“¦ å®‰è£…æ–¹å¼\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="pip install harborai==${VERSION#v}\n"
          CHANGELOG+="\`\`\`\n\n"
          CHANGELOG+="### ğŸ³ Dockeré•œåƒ\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION\n"
          CHANGELOG+="\`\`\`\n"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # åˆ›å»ºGitHub Release
  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, full-test-suite, build-package, build-docker, generate-changelog]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: dist-packages
          path: dist/
          
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-version.outputs.version }}
          name: HarborAI ${{ needs.validate-version.outputs.version }}
          body: ${{ needs.generate-changelog.outputs.changelog }}
          prerelease: ${{ needs.validate-version.outputs.is_prerelease }}
          files: |
            dist/*
          token: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ°PyPI
  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    environment:
      name: pypi
      url: https://pypi.org/p/harborai
    permissions:
      id-token: write
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: dist-packages
          path: dist/
          
      - name: å‘å¸ƒåˆ°PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # ä½¿ç”¨ Trusted Publishingï¼Œä¸éœ€è¦ repository-url

  # å‘å¸ƒåˆ°TestPyPIï¼ˆé¢„å‘å¸ƒç‰ˆæœ¬ï¼‰
  publish-test-pypi:
    name: å‘å¸ƒåˆ°TestPyPI
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'true'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/harborai
    permissions:
      id-token: write
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: dist-packages
          path: dist/
          
      - name: å‘å¸ƒåˆ°TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  # éƒ¨ç½²æ–‡æ¡£
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…æ–‡æ¡£ä¾èµ–
        run: |
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
          
      - name: æ„å»ºæ–‡æ¡£
        run: |
          mkdocs build
          
      - name: éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # å‘å¸ƒé€šçŸ¥
  notify-release:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate-version, create-release, publish-pypi, deploy-docs]
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: å‘é€å‘å¸ƒé€šçŸ¥
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate-version.outputs.is_prerelease }}"
          
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "ğŸ‰ HarborAI $VERSION é¢„å‘å¸ƒç‰ˆæœ¬å·²å‘å¸ƒï¼"
            echo "ğŸ“¦ TestPyPI: https://test.pypi.org/project/harborai/"
          else
            echo "ğŸš€ HarborAI $VERSION æ­£å¼ç‰ˆæœ¬å·²å‘å¸ƒï¼"
            echo "ğŸ“¦ PyPI: https://pypi.org/project/harborai/"
            echo "ğŸ“š æ–‡æ¡£: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi
          
          echo "ğŸ³ Docker: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
          echo "ğŸ“‹ å‘å¸ƒè¯´æ˜: https://github.com/${{ github.repository }}/releases/tag/$VERSION"