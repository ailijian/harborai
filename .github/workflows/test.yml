# HarborAIæµ‹è¯•CI/CDæµæ°´çº?name: HarborAI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»?    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - functional
          - performance
          - security
          - integration
          - all
      real_api:
        description: 'è¿è¡ŒçœŸå®APIæµ‹è¯•'
        required: false
        default: false
        type: boolean
      parallel:
        description: 'å¹¶è¡Œæ‰§è¡Œ'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  PYTEST_WORKERS: 4

jobs:
  # ä»£ç è´¨é‡æ£€æŸ?  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ?    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
          
      - name: ä»£ç æ ¼å¼æ£€æŸ?        run: |
          black --check --diff .
          isort --check-only --diff .
          
      - name: ä»£ç é£æ ¼æ£€æŸ?        run: |
          flake8 harborai/ tests/
          
      - name: ç±»å‹æ£€æŸ?        run: |
          mypy harborai/
          
      - name: å®‰å…¨æ£€æŸ?        run: |
          bandit -r harborai/ -f json -o security-report.json
          safety check --json --output safety-report.json
          
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-report.json
            safety-report.json

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          python -m pytest tests/unit/ \
            -v --tb=short \
            --cov=harborai \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=junit-unit.xml \
            --html=unit-report.html \
            --self-contained-html
            
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘?        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unit-tests
          name: codecov-${{ matrix.python-version }}
          
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-reports-${{ matrix.python-version }}
          path: |
            junit-unit.xml
            unit-report.html
            htmlcov/

  # åŠŸèƒ½æµ‹è¯•
  functional-tests:
    name: åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        test-group: 
          - 'test_a_* or test_b_* or test_c_*'  # APIå…¼å®¹æ€?          - 'test_d_* or test_e_* or test_f_*'  # æµå¼å’Œç»“æ„åŒ–è¾“å‡º
          - 'test_g_* or test_h_* or test_i_*'  # æ¨ç†æ¨¡å‹å’Œé”™è¯¯å¤„ç?          - 'test_j_* or test_k_* or test_l_*'  # å¹¶å‘å’Œèµ„æºç›‘æ?          - 'test_m_* or test_n_* or test_o_*'  # å®‰å…¨å’Œé›†æˆ?          - 'test_p_* or test_q_*'              # æ€§èƒ½å’Œå¯¹é½?    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        run: |
          cp .env.example .env.test
          mkdir -p tests/reports tests/logs
          
      - name: è¿è¡ŒåŠŸèƒ½æµ‹è¯•
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python -m pytest tests/functional/ \
            -v --tb=short \
            -k "${{ matrix.test-group }}" \
            -n ${{ env.PYTEST_WORKERS }} \
            --dist worksteal \
            --junit-xml=junit-functional-${{ strategy.job-index }}.xml \
            --html=functional-report-${{ strategy.job-index }}.html \
            --self-contained-html \
            -m "not real_api or (real_api and not slow)"
            
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: functional-test-reports-${{ strategy.job-index }}
          path: |
            junit-functional-*.xml
            functional-report-*.html

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: functional-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: harborai_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/harborai_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=$DATABASE_URL" >> .env.test
          echo "REDIS_URL=$REDIS_URL" >> .env.test
          
      - name: åˆå§‹åŒ–æ•°æ®åº“
        run: |
          python -c "
          import psycopg2
          conn = psycopg2.connect('postgresql://testuser:testpass@localhost:5432/harborai_test')
          cur = conn.cursor()
          cur.execute('CREATE EXTENSION IF NOT EXISTS uuid-ossp;')
          conn.commit()
          conn.close()
          "
          
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/harborai_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          python -m pytest tests/integration/ \
            -v --tb=short \
            --junit-xml=junit-integration.xml \
            --html=integration-report.html \
            --self-contained-html
            
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-reports
          path: |
            junit-integration.xml
            integration-report.html

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all'
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -m pytest tests/performance/ \
            -v --tb=short \
            -m "performance and not slow" \
            --junit-xml=junit-performance.xml \
            --html=performance-report.html \
            --self-contained-html \
            --benchmark-json=benchmark-results.json
            
      - name: æ€§èƒ½å›å½’æ£€æŸ?        run: |
          python tests/scripts/check_performance_regression.py \
            --current benchmark-results.json \
            --baseline tests/data/performance_baselines/baseline_v1.0.json \
            --threshold 0.1
            
      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-reports
          path: |
            junit-performance.xml
            performance-report.html
            benchmark-results.json

  # å®‰å…¨æµ‹è¯•
  security-tests:
    name: å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: functional-tests
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'security' || github.event.inputs.test_type == 'all'
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è¿è¡Œå®‰å…¨æµ‹è¯•
        run: |
          python -m pytest tests/security/ tests/functional/test_m_security.py \
            -v --tb=short \
            -m "security" \
            --junit-xml=junit-security.xml \
            --html=security-report.html \
            --self-contained-html
            
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-reports
          path: |
            junit-security.xml
            security-report.html

  # çœŸå®APIæµ‹è¯•ï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼?  real-api-tests:
    name: çœŸå®APIæµ‹è¯•
    runs-on: ubuntu-latest
    needs: functional-tests
    if: github.event.inputs.real_api == 'true' || github.event_name == 'schedule'
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
      - name: è¿è¡ŒçœŸå®APIæµ‹è¯•
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python -m pytest tests/functional/ \
            -v --tb=short \
            -m "real_api and not slow" \
            --junit-xml=junit-real-api.xml \
            --html=real-api-report.html \
            --self-contained-html
            
      - name: ä¸Šä¼ çœŸå®APIæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: real-api-test-reports
          path: |
            junit-real-api.xml
            real-api-report.html

  # ç”Ÿæˆç»¼åˆæŠ¥å‘Š
  generate-report:
    name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [unit-tests, functional-tests, integration-tests]
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç ?        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘?        uses: actions/download-artifact@v4
        with:
          path: test-artifacts
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…æŠ¥å‘Šç”Ÿæˆä¾èµ–
        run: |
          pip install jinja2 matplotlib seaborn pandas
          
      - name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          python tests/scripts/generate_comprehensive_report.py \
            --input-dir test-artifacts \
            --output-dir comprehensive-report \
            --format all
            
      - name: ä¸Šä¼ ç»¼åˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-report
          path: comprehensive-report/
          
      - name: éƒ¨ç½²æŠ¥å‘Šåˆ°GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./comprehensive-report
          destination_dir: test-reports/${{ github.run_number }}

  # è´¨é‡é—¨æ§
  quality-gate:
    name: è´¨é‡é—¨æ§
    runs-on: ubuntu-latest
    needs: [unit-tests, functional-tests, integration-tests]
    if: always()
    steps:
      - name: æ£€æŸ¥æµ‹è¯•ç»“æ?        run: |
          echo "æ£€æŸ¥è´¨é‡é—¨æ§æ¡ä»?.."
          
          # æ£€æŸ¥å•å…ƒæµ‹è¯•æ˜¯å¦é€šè¿‡
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "â?å•å…ƒæµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥åŠŸèƒ½æµ‹è¯•æ˜¯å¦é€šè¿‡
          if [[ "${{ needs.functional-tests.result }}" != "success" ]]; then
            echo "â?åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥é›†æˆæµ‹è¯•æ˜¯å¦é€šè¿‡
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "â?é›†æˆæµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          echo "âœ?æ‰€æœ‰è´¨é‡é—¨æ§æ¡ä»¶å·²æ»¡è¶³"
          
      - name: é€šçŸ¥æµ‹è¯•ç»“æœ
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ HarborAIæµ‹è¯•æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
          else
            echo "ğŸ’¥ HarborAIæµ‹è¯•æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
          fi
