# HarborAI 快速路径配置指南

## 概述

HarborAI 提供了快速路径（Fast Path）功能，可以显著提升 API 调用性能。快速路径通过绕过复杂的中间件和优化处理流程，实现更快的响应时间。

## 配置方式

### 1. 环境变量配置

#### 基础配置
```bash
# 设置性能模式为 fast（推荐）
HARBORAI_PERFORMANCE_MODE=fast

# 直接启用快速路径
HARBORAI_ENABLE_FAST_PATH=true

# 配置快速路径适用的模型（可选）
HARBORAI_FAST_PATH_MODELS=gpt-3.5-turbo,gpt-4,gpt-4-turbo
```

#### 完整环境变量示例
```bash
# 性能相关
HARBORAI_PERFORMANCE_MODE=fast
HARBORAI_ENABLE_FAST_PATH=true
HARBORAI_FAST_PATH_MODELS=gpt-3.5-turbo,gpt-4,gpt-4-turbo

# 功能开关
HARBORAI_ENABLE_COST_TRACKING=false
HARBORAI_ENABLE_CACHING=false
HARBORAI_ENABLE_MONITORING=false

# API 配置
HARBORAI_API_KEY=your_openai_api_key
HARBORAI_DEBUG=false
```

### 2. 代码配置

#### 方式一：通过 Settings 配置
```python
from harborai.config.settings import get_settings

# 获取设置实例
settings = get_settings()

# 检查快速路径状态
if settings.is_fast_path_enabled('gpt-4', max_tokens=1000):
    print("快速路径已启用")
else:
    print("快速路径未启用")
```

#### 方式二：通过 PerformanceConfig 配置
```python
from harborai.config.performance import PerformanceConfig, PerformanceMode

# 创建 fast 模式配置
config = PerformanceConfig(mode=PerformanceMode.fast)

# 检查是否应使用快速路径
if config.should_use_fast_path():
    print("应使用快速路径")

# 获取性能摘要
summary = config.get_performance_summary()
print(f"快速路径状态: {summary['fast_path']}")
```

#### 方式三：动态配置
```python
import os
from harborai.config.settings import get_settings

# 动态设置环境变量
os.environ['HARBORAI_PERFORMANCE_MODE'] = 'fast'
os.environ['HARBORAI_ENABLE_FAST_PATH'] = 'true'

# 重新加载配置（如果需要）
settings = get_settings()
```

### 3. 性能模式详解

#### FAST 模式（推荐高性能场景）
```python
# 特点：
# - 启用快速路径
# - 禁用成本追踪
# - 禁用缓存
# - 禁用监控
# - 最小化中间件

# 适用场景：
# - 生产环境高并发
# - 对延迟敏感的应用
# - 简单的 API 调用
```

#### BALANCED 模式（推荐一般场景）
```python
# 特点：
# - 有条件启用快速路径
# - 启用轻量级成本追踪
# - 启用基础缓存
# - 启用核心监控

# 适用场景：
# - 开发和测试环境
# - 需要基础监控的生产环境
# - 平衡性能和功能的场景
```

#### FULL 模式（推荐调试场景）
```python
# 特点：
# - 禁用快速路径
# - 启用完整成本追踪
# - 启用完整缓存
# - 启用详细监控
# - 启用所有中间件

# 适用场景：
# - 开发调试
# - 性能分析
# - 功能测试
```

## 使用示例

### 示例 1：基础快速路径使用
```python
import os
from harborai import HarborAI

# 设置快速路径
os.environ['HARBORAI_PERFORMANCE_MODE'] = 'fast'

# 创建客户端
client = HarborAI()

# 使用快速路径进行 API 调用
response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "user", "content": "Hello, world!"}
    ]
)

print(response.choices[0].message.content)
```

### 示例 2：条件性快速路径
```python
from harborai.config.settings import get_settings
from harborai import HarborAI

settings = get_settings()
client = HarborAI()

# 根据模型和 token 数量决定是否使用快速路径
model = "gpt-4"
max_tokens = 500

if settings.is_fast_path_enabled(model, max_tokens):
    print("使用快速路径")
    # 快速路径调用
else:
    print("使用标准路径")
    # 标准路径调用

response = client.chat.completions.create(
    model=model,
    messages=[{"role": "user", "content": "Explain quantum computing"}],
    max_tokens=max_tokens
)
```

### 示例 3：性能监控
```python
from harborai.config.performance import get_performance_config
from harborai import HarborAI
import time

config = get_performance_config()
client = HarborAI()

# 记录开始时间
start_time = time.time()

# API 调用
response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[{"role": "user", "content": "Hello!"}]
)

# 计算耗时
end_time = time.time()
duration = end_time - start_time

# 输出性能信息
print(f"调用耗时: {duration:.3f}s")
print(f"快速路径状态: {config.should_use_fast_path()}")
print(f"性能摘要: {config.get_performance_summary()}")
```

## 最佳实践

### 1. 生产环境配置
```bash
# 高性能生产环境
HARBORAI_PERFORMANCE_MODE=fast
HARBORAI_ENABLE_FAST_PATH=true
HARBORAI_ENABLE_COST_TRACKING=false
HARBORAI_ENABLE_CACHING=false
HARBORAI_ENABLE_MONITORING=false
```

### 2. 开发环境配置
```bash
# 开发调试环境
HARBORAI_PERFORMANCE_MODE=full
HARBORAI_ENABLE_FAST_PATH=false
HARBORAI_ENABLE_COST_TRACKING=true
HARBORAI_ENABLE_CACHING=true
HARBORAI_ENABLE_MONITORING=true
HARBORAI_DEBUG=true
```

### 3. 测试环境配置
```bash
# 测试环境
HARBORAI_PERFORMANCE_MODE=balanced
HARBORAI_ENABLE_FAST_PATH=true
HARBORAI_ENABLE_COST_TRACKING=true
HARBORAI_ENABLE_CACHING=true
HARBORAI_ENABLE_MONITORING=true
```

## 性能对比

| 模式 | 首次响应时间 | 并发处理能力 | 功能完整性 | 适用场景 |
|------|-------------|-------------|-----------|----------|
| FAST | 最快 (-70%) | 最高 (+300%) | 基础 | 生产高并发 |
| BALANCED | 中等 (-30%) | 中等 (+100%) | 平衡 | 一般应用 |
| FULL | 标准 | 标准 | 完整 | 开发调试 |

## 故障排查

### 1. 快速路径未生效
```python
# 检查配置
from harborai.config.settings import get_settings
from harborai.config.performance import get_performance_config

settings = get_settings()
config = get_performance_config()

print(f"性能模式: {settings.performance_mode}")
print(f"快速路径启用: {settings.enable_fast_path}")
print(f"应使用快速路径: {config.should_use_fast_path()}")
print(f"性能摘要: {config.get_performance_summary()}")
```

### 2. 性能未提升
- 检查模型是否在快速路径支持列表中
- 确认 token 数量未超过阈值
- 验证环境变量设置正确
- 检查是否有其他中间件影响

### 3. 功能缺失
- fast 模式会禁用某些功能（成本追踪、缓存等）
- 如需这些功能，请使用 balanced 或 full 模式
- 可以通过自定义配置启用特定功能

## 注意事项

1. **功能权衡**：快速路径会禁用某些功能以提升性能
2. **模型支持**：并非所有模型都支持快速路径
3. **Token 限制**：大型请求可能不适用快速路径
4. **监控缺失** fast 模式下监控功能有限
5. **调试困难**：快速路径下调试信息较少

## 总结

快速路径是 HarborAI 的重要性能优化功能，通过合理配置可以显著提升 API 调用性能。建议根据具体使用场景选择合适的性能模式，并在生产环境中充分测试后再启用。